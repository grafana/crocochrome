name: Push/PR

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: none

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false
      - uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6
        with:
          go-version-file: go.mod
      - run: |
          make build

  test:
    name: Test
    strategy:
      matrix:
        platform: [ ubuntu-latest, ubuntu-24.04-arm ]
      fail-fast: false
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false
      - run: |
          make test

  build-container:
    name: Build container image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
      - name: Build contianer
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          push: false
          tags: ci.local/crocochrome:${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  golangci:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false
      - name: Sanity check .dockerignore
        run: |-
          if [[ -e ".dockerignore" ]]; then
            cat <<EOF
          .dockerignore will prevent files tracked by git from being copied into the container, which in turn will
          cause Go to see the build tree as "dirty", and self-report the version as dirty too. This will cause
          problems with the deployment process.

          Please remove .dockerignore.
          If you _really_ need .dockerignore, make sure .gitignore is a superset of .dockerignore, and change this
          step to test for that.
          EOF

            exit 1
          fi
      - uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6
        with:
          go-version-file: go.mod
          cache: false # Recommended by golangci-lint, undocumented why.
      # Get golangci-lint version present in grafana-build-tools.
      - id: version
        run: |-
          echo "golangci=$(make lint-version)" >> $GITHUB_OUTPUT
      # Use the golangci-lint action, which provides Github-specific features such as diff annotations.
      - name: golangci-lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84 # v6
        with:
          version: ${{ steps.version.golangci }}
